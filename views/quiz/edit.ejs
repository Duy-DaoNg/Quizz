<% layout = false %>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Quiz - Quiz App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="/css/modern_quiz_edit.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
</head>
<body>

<!-- Auto-save indicator -->
<div class="auto-save" id="autoSaveIndicator">
    <i class="fas fa-check-circle me-2"></i>
    Changes saved
</div>

<div class="modern-quiz-editor">
    <!-- Header Section -->
    <div class="editor-header animate-fade-in">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="header-content">
                        <h1 class="editor-title">
                            <i class="fas fa-edit me-3"></i>
                            Edit Quiz
                        </h1>
                        <p class="editor-subtitle">Update your quiz content and settings</p>
                        <div class="quiz-meta">
                            <span class="meta-badge">
                                <i class="fas fa-calendar me-1"></i>
                                Created <%= new Date(quiz.createdAt).toLocaleDateString() %>
                            </span>
                            <span class="meta-badge">
                                <i class="fas fa-clock me-1"></i>
                                Last updated <%= new Date(quiz.updatedAt).toLocaleDateString() %>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <div class="header-actions">
                        <a href="/quizzes" class="btn btn-outline-light me-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Dashboard
                        </a>
                        <button class="btn btn-light" onclick="previewQuiz()" data-bs-toggle="modal" data-bs-target="#previewModal">
                            <i class="fas fa-eye me-2"></i>
                            Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Quiz Information -->
    <div class="modern-card animate-slide-up">
        <div class="card-header-modern">
            <h4 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Quiz Information
            </h4>
        </div>
        <div class="card-body-modern">
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-floating-modern">
                        <input type="text" class="form-control-modern" id="quizTitle" placeholder=" " 
                               value="<%= quiz.title %>" required>
                        <label class="form-label-modern">Quiz Title</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <select class="form-control-modern" id="quizMode" onchange="toggleScheduleSettings()">
                                    <option value="online" <%= quiz.mode === 'online' ? 'selected' : '' %>>Online Mode</option>
                                    <option value="offline" <%= quiz.mode === 'offline' ? 'selected' : '' %>>Scheduled Mode</option>
                                </select>
                                <label class="form-label-modern">Quiz Mode</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <select class="form-control-modern" id="quizLanguage">
                                    <option value="vietnamese" <%= quiz.language === 'vietnamese' ? 'selected' : '' %>>Vietnamese</option>
                                    <option value="english" <%= quiz.language === 'english' ? 'selected' : '' %>>English</option>
                                </select>
                                <label class="form-label-modern">Language</label>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Settings -->
                    <div id="scheduleSettings" style="display: <%= quiz.mode === 'offline' ? 'block' : 'none' %>;">
                        <div class="alert alert-info">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Schedule your quiz for specific time periods
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <input type="datetime-local" class="form-control-modern" id="startTime"
                                           value="<%= quiz.scheduleSettings?.startTime ? new Date(quiz.scheduleSettings.startTime).toISOString().slice(0, 16) : '' %>">
                                    <label class="form-label-modern">Start Time</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <input type="datetime-local" class="form-control-modern" id="endTime"
                                           value="<%= quiz.scheduleSettings?.endTime ? new Date(quiz.scheduleSettings.endTime).toISOString().slice(0, 16) : '' %>">
                                    <label class="form-label-modern">End Time</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="d-flex flex-column h-100">
                        <h6 class="text-primary mb-3">Current Stats</h6>
                        <div class="stat-card-mini">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded mb-2">
                                <span class="text-muted">Questions</span>
                                <span class="fw-bold" id="questionCount"><%= quiz.questions.length %></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded mb-2">
                                <span class="text-muted">Participants</span>
                                <span class="fw-bold">0</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <span class="text-muted">Status</span>
                                <span class="badge bg-success">Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Section -->
    <div class="modern-card animate-slide-up">
        <div class="card-header-modern d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-question-circle me-2"></i>
                Quiz Questions
            </h4>
            <button class="btn btn-outline-light" onclick="addQuestion()">
                <i class="fas fa-plus me-2"></i>
                Add Question
            </button>
        </div>
        <div class="card-body-modern">
            <div id="questionsContainer">
                <% quiz.questions.forEach((question, index) => { %>
                    <div class="question-card-modern animate-slide-up" id="question-<%= index + 1 %>">
                        <div class="question-header">
                            <div class="d-flex align-items-center flex-grow-1">
                                <div class="question-number"><%= index + 1 %></div>
                                <h5 class="mb-0">Question <%= index + 1 %></h5>
                            </div>
                            <div class="question-actions">
                                <button class="action-btn" onclick="moveQuestion(<%= index + 1 %>, 'up')" title="Move Up">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="action-btn" onclick="moveQuestion(<%= index + 1 %>, 'down')" title="Move Down">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button class="action-btn" onclick="duplicateQuestion(<%= index + 1 %>)" title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="action-btn danger" onclick="deleteQuestion(<%= index + 1 %>)" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body-modern">
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="form-floating-modern">
                                        <textarea class="form-control-modern" id="question-<%= index + 1 %>-content" 
                                                  placeholder=" " rows="3" 
                                                  oninput="updateQuestion(<%= index + 1 %>, 'content', this.value)"><%= question.content %></textarea>
                                        <label class="form-label-modern">Question Content</label>
                                    </div>
                                    
                                    <div class="form-floating-modern">
                                        <select class="form-control-modern" id="question-<%= index + 1 %>-type" 
                                                onchange="toggleQuestionType(<%= index + 1 %>, this.value)">
                                            <option value="multiple_choice" <%= question.type === 'multiple_choice' ? 'selected' : '' %>>Multiple Choice A/B/C/D</option>
                                            <option value="text_input" <%= question.type === 'text_input' ? 'selected' : '' %>>Text Input</option>
                                        </select>
                                        <label class="form-label-modern">Question Type</label>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="image-upload-zone <% if (question.image) { %>has-image<% } %>" onclick="document.getElementById('image-<%= index + 1 %>').click()">
                                        <input type="file" id="image-<%= index + 1 %>" accept="image/*" style="display: none;" 
                                               onchange="handleImageUpload(<%= index + 1 %>, this)">
                                        <% if (question.image) { %>
                                            <img src="<%= question.image %>" alt="Question Image" 
                                                 style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeImage(<%= index + 1 %>, event)" type="button">
                                                    <i class="fas fa-trash me-1"></i> Remove
                                                </button>
                                            </div>
                                        <% } else { %>
                                            <div class="upload-content">
                                                <div class="upload-icon">
                                                    <i class="fas fa-cloud-upload-alt"></i>
                                                </div>
                                                <h6>Upload Image</h6>
                                                <p class="text-muted small mb-0">Click to select image</p>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="answer-options" id="options-<%= index + 1 %>">
                                <h6 class="text-primary mb-3">Answer Options</h6>
                                <% if (question.type === 'multiple_choice') { %>
                                    <% ['A', 'B', 'C', 'D'].forEach((letter, optIndex) => { %>
                                        <div class="option-group">
                                            <div class="option-radio <%= question.correctAnswer && question.correctAnswer.includes(letter) ? 'checked' : '' %>" 
                                                 id="radio-<%= index + 1 %>-<%= letter %>" 
                                                 onclick="selectCorrectAnswer(<%= index + 1 %>, '<%= letter %>')"></div>
                                            <div class="option-letter"><%= letter %></div>
                                            <input type="text" class="form-control-modern flex-grow-1" 
                                                   placeholder="Enter option <%= letter %>" 
                                                   id="option-<%= index + 1 %>-<%= letter %>"
                                                   value="<%= question.options.find(opt => opt.letter === letter)?.text || '' %>"
                                                   oninput="updateQuestion(<%= index + 1 %>, 'option<%= letter %>', this.value)">
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Students will type their answer in a text field.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
            
            <!-- Add Question Button -->
            <div class="add-question-btn" onclick="addQuestion()">
                <div class="add-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <h5 class="mb-2">Add New Question</h5>
                <p class="text-muted mb-0">Click to add another question to your quiz</p>
            </div>
        </div>
    </div>

</div>
<!-- Submit Section -->
<div class="row">
    <div class="col-12">
        <div class="submit-section text-center">
            <h4 class="text-white mb-3">Ready to Create Your Quiz?</h4>
            <p class="text-white-50 mb-4">Review all questions and settings before submitting</p>
            <div class="d-flex gap-3 justify-content-center">
                <button type="button" class="btn btn-outline-light btn-lg px-4" 
                        data-bs-toggle="modal" data-bs-target="#previewModal" 
                        onclick="previewQuiz()">
                    <i class="fas fa-eye me-2"></i>Preview Quiz
                </button>
                <button type="button" class="btn btn-light btn-lg px-5" onclick="updateQuiz()">
                    <i class="fas fa-check-circle me-2"></i>Update Quiz
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Preview Modal -->
<div class="modal fade preview-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body p-0">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Quiz Content -->
                        <div class="col-lg-9 p-4">
                            <div class="quiz-header mb-4">
                                <h3 class="text-primary mb-3" id="previewTitle"></h3>
                                <div class="row text-muted small">
                                    <div class="col-md-4">
                                        <i class="fas fa-globe me-1"></i>
                                        <span id="previewMode"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <i class="fas fa-language me-1"></i>
                                        <span id="previewLanguage"></span>
                                    </div>
                                    <div class="col-md-4" id="previewSchedule">
                                    </div>
                                </div>
                            </div>
                            <div id="previewQuestionsContainer">
                                <!-- Questions will be inserted here -->
                            </div>
                        </div>

                        <!-- Sticky Sidebar -->
                        <div class="col-lg-3 bg-light" style="padding-left: 0px;">
                            <div class="quiz-sidebar preview-sidebar">
                                <!-- Timer Section -->
                                <div class="quiz-timer p-3 mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-stopwatch me-2 text-warning"></i>
                                        <strong>Time Remaining</strong>
                                    </div>
                                    <div class="h4 text-center text-warning mb-0">
                                        <span id="previewTimer">45:00</span>
                                    </div>
                                </div>

                                <!-- Navigator Section -->
                                <div class="mb-3">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-list-ol me-1"></i>Question Navigator
                                    </h6>
                                    <div id="previewNavigator" class="d-flex flex-wrap gap-2">
                                        <!-- Navigation buttons will be inserted here -->
                                    </div>
                                </div>

                                <!-- Progress Section -->
                                <div class="progress mb-3" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%" 
                                            id="previewProgress" aria-valuenow="0" aria-valuemin="0" 
                                            aria-valuemax="100"></div>
                                </div>

                                <!-- Modal Actions -->
                                <div class="mt-4">
                                    <button type="button" class="btn btn-secondary w-100 mb-2" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-2"></i>Close Preview
                                    </button>
                                    <button type="button" class="btn btn-primary w-100" onclick="editQuiz()">
                                        <i class="fas fa-edit me-2"></i>Continue Editing
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/quiz_common_create_edit.js"></script>

<!-- Initialize quiz data safely -->
<script>
// Initialize quiz data safely to avoid syntax errors
window.quizData = {
    id: '<%= quiz._id %>',
    title: <%- JSON.stringify(quiz.title) %>,
    mode: '<%= quiz.mode %>',
    language: '<%= quiz.language %>',
    scheduleSettings: <%- JSON.stringify(quiz.scheduleSettings || null) %>,
    questions: <%- JSON.stringify(quiz.questions.map((question, index) => ({
        id: index + 1,
        type: question.type,
        content: question.content,
        options: ['A', 'B', 'C', 'D'].map(letter => 
            question.options.find(opt => opt.letter === letter)?.text || ''
        ),
        correctAnswer: question.correctAnswer && question.correctAnswer.length > 0 ? question.correctAnswer[0] : '',
        image: question.image || null
    }))) %>
};

// Set global variables
const quizId = window.quizData.id;
let questionCount = window.quizData.questions.length;
let questions = window.quizData.questions;
let autoSaveTimer;
let previewTimer;
let hasUnsavedChanges = false;

window.questions = questions;
window.questionCount = questionCount;
window.autoSaveTimer = autoSaveTimer;
window.previewTimer = previewTimer;
window.hasUnsavedChanges = hasUnsavedChanges;
</script>

<script src="/js/modern_quiz_edit.js"></script>
</body>
</html>